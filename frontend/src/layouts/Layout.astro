---
import { ViewTransitions } from 'astro:transitions';
import Sidebar from '../components/Sidebar.astro';
import Header from '../components/Header.astro';
import LoginModal from '../components/LoginModal.jsx';
import LoadingScreen from '../components/LoadingScreen.astro';
import MobileNavigation from '../components/MobileNavigation.jsx';
import 'nprogress/nprogress.css';
import '../styles/global.css';

const { title, hideNavigation = false } = Astro.props;

const userId = Astro.cookies.get('user_id')?.value;
const userNameRaw = Astro.cookies.get('user_name')?.value;
const userName = userNameRaw ? decodeURIComponent(userNameRaw) : null;
const userAvatar = Astro.cookies.get('user_avatar')?.value;
const user = { id: userId, name: userName, avatar: userAvatar };

const currentPath = Astro.url.pathname;
const queryParams = Astro.url.search;
const channelId = Astro.url.searchParams.get('channel');

const parts = currentPath.split('/').filter(Boolean);
const mode = parts[0] === 'open' ? 'Overview' : 'Monthly';
const year = parts[1];
const month = parts[2];
const isDashboard = currentPath.includes('/month/') || currentPath.includes('/open/');
---

<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>{title} | やまかわてるき鯖 統計</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Dela+Gothic+One&family=JetBrains+Mono:wght@400;700&family=Noto+Sans+JP:wght@400;700&family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">
        <ViewTransitions />
        <style is:global>
            #nprogress .bar { background: #3b82f6 !important; height: 3px !important; z-index: 10001 !important; }
            .custom-scrollbar::-webkit-scrollbar { width: 6px; }
            .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
            .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 20px; }
            
            @media (max-width: 767px) {
                .mobile-content-pt { padding-top: 8.5rem !important; }
            }
        </style>
	</head>
	<body class="bg-gray-50 text-gray-900 font-sans min-h-screen flex flex-col md:flex-row">
    
    <LoadingScreen />

    {!hideNavigation ? (
        <>
            <Sidebar transition:persist />

            <div class="md:hidden">
                <MobileNavigation 
                    client:load 
                    user={user} 
                    currentPath={currentPath}
                    queryParams={queryParams}
                />
            </div>

            <div class="flex-1 min-w-0 md:ml-80 flex flex-col transition-all mobile-content-pt relative">
                <Header /> 
                
                <main class="px-4 md:px-8 lg:p-12 flex-1 pb-32">
                    {isDashboard && (
                        <div class="md:hidden mb-6 flex items-center justify-center text-[10px] font-bold text-gray-400 bg-white/90 py-3 px-5 rounded-2xl border border-gray-100 shadow-sm backdrop-blur-lg mx-auto w-fit">
                            <span class="text-gray-900 uppercase tracking-widest">{mode}</span>
                            {year && <span><span class="mx-2 text-gray-200">/</span>{year}年 {month}月</span>}
                            {channelId && <span><span class="mx-2 text-gray-200">/</span><span class="text-blue-600">CH_{channelId}</span></span>}
                        </div>
                    )}

                    <slot />
                </main>

                {/* ▼ フッター修正 ▼ */}
                <footer class="mt-auto py-12 border-t border-gray-100 bg-white/50 backdrop-blur-sm relative z-0">
                    <div class="max-w-7xl mx-auto px-8 flex flex-col items-center gap-8">
                        {/* リンクエリア: ソースコード追加 */}
                        <div class="flex flex-wrap justify-center items-center gap-4 sm:gap-6 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                            <a href="/terms" class="hover:text-blue-600 transition-colors">利用規約</a>
                            <span class="text-gray-300">/</span>
                            <a href="/privacy" class="hover:text-blue-600 transition-colors">プライバシーポリシー</a>
                            <span class="text-gray-300">/</span>
                            <a href="https://github.com/y-exe/ymkw-top" target="_blank" rel="noopener noreferrer" class="hover:text-black transition-colors flex items-center gap-1 group">
                                ソースコード
                                {/* External Link Icon */}
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="opacity-50 group-hover:opacity-100 transition-opacity"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                            </a>
                        </div>
                        
                        {/* コピーライトエリア: 普通の書体に修正 */}
                        <div class="flex flex-col items-center gap-2">
                            <p class="text-xs text-gray-500 font-medium">
                                © 2025 ymkw.top <span class="mx-1 text-gray-300">|</span> <span class="text-gray-400">Built by yexe</span>
                            </p>
                        </div>
                    </div>
                </footer>
            </div>
        </>
    ) : (
        <main class="min-h-screen w-full relative"><slot /></main>
    )}

    <LoginModal client:load />

    <script>
      import NProgress from 'nprogress';
      NProgress.configure({ showSpinner: false, speed: 400 });
      document.addEventListener('astro:before-preparation', () => NProgress.start());
      window.addEventListener('app-loaded', () => NProgress.done());
      document.addEventListener('astro:after-swap', () => setTimeout(() => NProgress.done(), 8000));
    </script>
	</body>
</html>