---
const { url } = Astro;
const channelId = url.searchParams.get('channel');

const API_URL = "http://api.ymkw.top";
let channelName = "All Channels";
if (channelId) {
    try {
        const res = await fetch(`${API_URL}/api/channels`);
        if (res.ok) {
            const channels = await res.json();
            const found = channels.find(c => String(c.id) === String(channelId));
            if (found) channelName = found.name;
        }
    } catch(e) {}
}

const userId = Astro.cookies.get('user_id')?.value;
const userNameRaw = Astro.cookies.get('user_name')?.value;
const userName = userNameRaw ? decodeURIComponent(userNameRaw) : null;
const userAvatar = Astro.cookies.get('user_avatar')?.value;

const parts = url.pathname.split('/').filter(Boolean);
const mode = parts[0] === 'open' ? 'Overview' : 'Monthly';
const year = parts[1];
const month = parts[2];
---

<header class="h-16 bg-white border-b border-gray-100 hidden md:flex items-center justify-between px-8 sticky top-0 z-40 shadow-sm/50">
    <!-- 左側のナビゲーション (変更なし) -->
    <nav class="flex items-center text-sm font-medium text-gray-500">
        <span class="hover:text-black transition-colors cursor-default">{mode}</span>
        {year && !url.pathname.includes('/open/') && <span class="mx-2 text-gray-300">/</span>}
        {year && !url.pathname.includes('/open/') && <span>{year}年{month ? ` ${month}月` : ''}</span>}
        <span class="mx-2 text-gray-300">/</span>
        <span class={`flex items-center gap-1 ${channelId ? 'text-blue-600 bg-blue-50 px-2 py-0.5 rounded' : ''}`}>
            {channelId && <span class="w-1.5 h-1.5 rounded-full bg-blue-500"></span>}
            {channelName}
        </span>
    </nav>

    <!-- 右側のユーザー情報 (ここを修正) -->
    <div class="relative group">
        {userId && userId !== 'guest' ? (
            <div class="flex items-center gap-3">
                {/* テキストエリア: 名前とOnline表示 */}
                <div class="text-right hidden md:flex flex-col justify-center flex-shrink-0">
                    <p class="text-sm font-bold text-gray-900 leading-none truncate max-w-[300px] whitespace-nowrap" title={userName}>
                        {userName}
                    </p>
                    <div class="flex items-center justify-end gap-1.5 mt-1">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        <span class="text-[10px] text-green-600 font-bold uppercase tracking-wider">Online</span>
                    </div>
                </div>

                {/* アバターボタン */}
                <button class="flex-shrink-0 relative focus:outline-none">
                    {userAvatar && userAvatar !== 'None' ? (
                        <img src={userAvatar} class="w-9 h-9 rounded-full border border-gray-200 shadow-sm object-cover" />
                    ) : (
                        <div class="w-9 h-9 rounded-full bg-gray-900 text-white flex items-center justify-center text-sm font-bold shadow-sm">
                            {userName ? userName[0] : 'U'}
                        </div>
                    )}
                    
                    {/* ログアウトドロップダウン */}
                    <div class="absolute right-0 top-full mt-2 w-36 bg-white border border-gray-100 rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 transform origin-top-right z-50">
                        <div class="py-1">
                            <button 
                                onclick="document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/')); location.reload();" 
                                class="flex items-center w-full px-4 py-2.5 text-xs text-red-500 hover:bg-red-50 font-bold transition-colors"
                            >
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                Log out
                            </button>
                        </div>
                    </div>
                </button>
            </div>
        ) : (
            <button onclick="document.cookie = 'user_id=; path=/; max-age=0'; location.reload();" class="text-sm font-bold text-black bg-gray-100 px-5 py-2 rounded-xl hover:bg-gray-200 transition-all active:scale-95">
                Login
            </button>
        )}
    </div>
</header>