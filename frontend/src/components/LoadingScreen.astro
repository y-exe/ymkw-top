<div 
    id="loading-screen" 
    transition:persist
    class="fixed inset-0 flex items-center justify-center bg-[#ff0000] z-[9999]"
    style="display: none; opacity: 1;"
>
    <div 
        class="loader-grid relative font-zakkuri leading-none select-none text-white"
        style="width: var(--loader-size); height: var(--loader-size); will-change: transform;"
    >
        <span class="char char-1 absolute flex items-center justify-center">か</span>
        <span class="char char-2 absolute flex items-center justify-center">や</span>
        <span class="char char-3 absolute flex items-center justify-center">わ</span>
        <span class="char char-4 absolute flex items-center justify-center">ま</span>
    </div>
</div>

<style>
    @font-face {
        font-family: 'ZakkuriGothic';
        src: url('/fonts/ZakkuriGothicFree-Black.otf') format('opentype');
        font-display: swap;
    }
    .font-zakkuri { font-family: 'ZakkuriGothic', sans-serif; }
    :root { --loader-size: 200px; }
    @media (min-width: 768px) { :root { --loader-size: 280px; } }

    .char {
        width: 50%; height: 50%; color: #ffffff !important;
        line-height: 0.65; font-size: calc(var(--loader-size) * 0.52);
        animation-duration: 4s; animation-iteration-count: infinite;
        animation-timing-function: cubic-bezier(0.22, 1, 0.36, 1);
        will-change: top, left; 
    }
    .char-1 { animation-name: move-ya; }
    .char-2 { animation-name: move-ma; }
    .char-3 { animation-name: move-ka; }
    .char-4 { animation-name: move-wa; }

    @keyframes move-ya { 0%, 100% {top:0;left:0} 15%,25% {top:50%;left:0} 40%,50% {top:50%;left:50%} 65%,75% {top:0;left:50%} }
    @keyframes move-ma { 0%, 100% {top:0;left:50%} 15%,25% {top:0;left:0} 40%,50% {top:50%;left:0} 65%,75% {top:50%;left:50%} }
    @keyframes move-ka { 0%, 100% {top:50%;left:0} 15%,25% {top:50%;left:50%} 40%,50% {top:0;left:50%} 65%,75% {top:0;left:0} }
    @keyframes move-wa { 0%, 100% {top:50%;left:50%} 15%,25% {top:0;left:50%} 40%,50% {top:0;left:0} 65%,75% {top:50%;left:0} }
</style>

<script is:inline>
    (function() {
        const MIN_DURATION = 1200;
        let startTime = Date.now();

        const show = () => {
            const screen = document.getElementById('loading-screen');
            if (!screen) return;
            startTime = Date.now();
            window.__ymkw_data_ready = false;
            screen.style.transition = 'none';
            screen.style.display = 'flex';
            screen.style.opacity = '1';
        };

        const hide = () => {
            const screen = document.getElementById('loading-screen');
            if (!screen || screen.style.display === 'none') return;
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, MIN_DURATION - elapsed);

            setTimeout(() => {
                screen.style.transition = 'opacity 0.5s ease';
                screen.style.opacity = '0';
                setTimeout(() => {
                    if (screen.style.opacity === '0') screen.style.display = 'none';
                }, 500);
            }, remaining);
        };

        if (window.location.pathname.includes('/month/') || window.location.pathname.includes('/open/')) {
            show();
        }

        document.addEventListener('astro:before-preparation', show);
        document.addEventListener('astro:after-swap', () => {
            if (!window.location.pathname.includes('/month/') && !window.location.pathname.includes('/open/')) {
                hide();
            }
        });

        window.addEventListener('app-loaded', hide);
    })();
</script>